#!/bin/bash
#
# shadow-pkg - ShadowOS Universal Package Manager
# /usr/bin/shadow-pkg
#
# Unified interface for package management across different backends
# Supports: apk (Alpine), apt (Debian), dnf (Fedora), pacman (Arch)
#

set -euo pipefail

VERSION="1.0.0"

# =============================================================================
# BACKEND DETECTION
# =============================================================================

detect_backend() {
    if command -v apk &>/dev/null; then
        echo "apk"
    elif command -v apt &>/dev/null; then
        echo "apt"
    elif command -v dnf &>/dev/null; then
        echo "dnf"
    elif command -v pacman &>/dev/null; then
        echo "pacman"
    else
        echo "unknown"
    fi
}

BACKEND=$(detect_backend)

# =============================================================================
# PACKAGE NAME MAPPING
# Some packages have different names across distros
# =============================================================================

declare -A PKG_MAP_APK=(
    ["wireshark"]="wireshark"
    ["nmap"]="nmap"
    ["metasploit"]="metasploit-framework"
    ["burpsuite"]="burpsuite"
    ["john"]="john"
    ["hashcat"]="hashcat"
)

declare -A PKG_MAP_APT=(
    ["wireshark"]="wireshark"
    ["nmap"]="nmap"
    ["metasploit"]="metasploit-framework"
    ["john"]="john"
    ["hashcat"]="hashcat"
)

declare -A PKG_MAP_DNF=(
    ["wireshark"]="wireshark"
    ["nmap"]="nmap"
    ["john"]="john"
)

declare -A PKG_MAP_PACMAN=(
    ["wireshark"]="wireshark-qt"
    ["nmap"]="nmap"
    ["metasploit"]="metasploit"
    ["john"]="john"
    ["hashcat"]="hashcat"
)

# Resolve package name for current backend
resolve_pkg() {
    local pkg="$1"
    local mapped=""
    
    case "$BACKEND" in
        apk)    mapped="${PKG_MAP_APK[$pkg]:-}" ;;
        apt)    mapped="${PKG_MAP_APT[$pkg]:-}" ;;
        dnf)    mapped="${PKG_MAP_DNF[$pkg]:-}" ;;
        pacman) mapped="${PKG_MAP_PACMAN[$pkg]:-}" ;;
    esac
    
    echo "${mapped:-$pkg}"
}

# =============================================================================
# COMMANDS
# =============================================================================

cmd_install() {
    local packages=("$@")
    local resolved=()
    
    for pkg in "${packages[@]}"; do
        resolved+=("$(resolve_pkg "$pkg")")
    done
    
    echo "[shadow-pkg] Installing: ${resolved[*]}"
    
    case "$BACKEND" in
        apk)
            apk add "${resolved[@]}"
            ;;
        apt)
            apt-get update
            apt-get install -y "${resolved[@]}"
            ;;
        dnf)
            dnf install -y "${resolved[@]}"
            ;;
        pacman)
            pacman -S --noconfirm "${resolved[@]}"
            ;;
        *)
            echo "[!] Unknown package manager"
            exit 1
            ;;
    esac
}

cmd_remove() {
    local packages=("$@")
    
    echo "[shadow-pkg] Removing: ${packages[*]}"
    
    case "$BACKEND" in
        apk)
            apk del "${packages[@]}"
            ;;
        apt)
            apt-get remove -y "${packages[@]}"
            ;;
        dnf)
            dnf remove -y "${packages[@]}"
            ;;
        pacman)
            pacman -R --noconfirm "${packages[@]}"
            ;;
    esac
}

cmd_update() {
    echo "[shadow-pkg] Updating package database..."
    
    case "$BACKEND" in
        apk)
            apk update
            ;;
        apt)
            apt-get update
            ;;
        dnf)
            dnf check-update || true
            ;;
        pacman)
            pacman -Sy
            ;;
    esac
}

cmd_upgrade() {
    echo "[shadow-pkg] Upgrading all packages..."
    
    case "$BACKEND" in
        apk)
            apk upgrade
            ;;
        apt)
            apt-get update
            apt-get upgrade -y
            ;;
        dnf)
            dnf upgrade -y
            ;;
        pacman)
            pacman -Syu --noconfirm
            ;;
    esac
}

cmd_search() {
    local query="$1"
    
    case "$BACKEND" in
        apk)
            apk search "$query"
            ;;
        apt)
            apt-cache search "$query"
            ;;
        dnf)
            dnf search "$query"
            ;;
        pacman)
            pacman -Ss "$query"
            ;;
    esac
}

cmd_info() {
    local pkg="$1"
    
    case "$BACKEND" in
        apk)
            apk info "$pkg"
            ;;
        apt)
            apt-cache show "$pkg"
            ;;
        dnf)
            dnf info "$pkg"
            ;;
        pacman)
            pacman -Si "$pkg" 2>/dev/null || pacman -Qi "$pkg"
            ;;
    esac
}

cmd_list() {
    case "$BACKEND" in
        apk)
            apk list --installed
            ;;
        apt)
            dpkg -l
            ;;
        dnf)
            dnf list installed
            ;;
        pacman)
            pacman -Q
            ;;
    esac
}

cmd_clean() {
    echo "[shadow-pkg] Cleaning package cache..."
    
    case "$BACKEND" in
        apk)
            apk cache clean
            ;;
        apt)
            apt-get clean
            apt-get autoclean
            apt-get autoremove -y
            ;;
        dnf)
            dnf clean all
            ;;
        pacman)
            pacman -Sc --noconfirm
            ;;
    esac
}

# Flatpak integration for GUI apps
cmd_flatpak() {
    local action="$1"
    shift
    
    if ! command -v flatpak &>/dev/null; then
        echo "[!] Flatpak not installed. Installing..."
        cmd_install flatpak
    fi
    
    case "$action" in
        install)
            flatpak install -y flathub "$@"
            ;;
        remove)
            flatpak uninstall -y "$@"
            ;;
        search)
            flatpak search "$@"
            ;;
        list)
            flatpak list
            ;;
        update)
            flatpak update -y
            ;;
    esac
}

show_help() {
    cat << EOF
shadow-pkg - ShadowOS Universal Package Manager

Usage: shadow-pkg <command> [packages...]

Commands:
  install <pkg...>      Install packages
  remove <pkg...>       Remove packages
  update                Update package database
  upgrade               Upgrade all packages
  search <query>        Search for packages
  info <pkg>            Show package info
  list                  List installed packages
  clean                 Clean package cache
  
  flatpak <cmd> <pkg>   Flatpak operations (install/remove/search/update)

Backend: $BACKEND

Examples:
  shadow-pkg install nmap wireshark
  shadow-pkg search metasploit
  shadow-pkg flatpak install org.mozilla.firefox

EOF
}

# =============================================================================
# MAIN
# =============================================================================

if [[ $# -eq 0 ]]; then
    show_help
    exit 0
fi

case "$1" in
    install|add|i)
        shift
        cmd_install "$@"
        ;;
    remove|uninstall|rm|r)
        shift
        cmd_remove "$@"
        ;;
    update|up)
        cmd_update
        ;;
    upgrade|ug)
        cmd_upgrade
        ;;
    search|s|find)
        shift
        cmd_search "$1"
        ;;
    info|show)
        shift
        cmd_info "$1"
        ;;
    list|ls)
        cmd_list
        ;;
    clean|clear)
        cmd_clean
        ;;
    flatpak|fp)
        shift
        cmd_flatpak "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "[!] Unknown command: $1"
        show_help
        exit 1
        ;;
esac
