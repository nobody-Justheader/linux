#!/bin/bash
#
# shadow-report - Generate Operation Reports
# /usr/bin/shadow-report
#
# Create formatted reports from captured data
#

set -euo pipefail

VERSION="1.0.0"
REPORT_DIR="/shadow/reports"
SHADOW_DIR="/shadow"

log() { echo "[report] $*"; }
error() { echo "[report] ERROR: $*" >&2; exit 1; }

# Generate summary report
cmd_summary() {
    local outfile="${1:-$REPORT_DIR/summary_$(date +%Y%m%d_%H%M%S).md}"
    
    mkdir -p "$REPORT_DIR"
    
    log "Generating summary report..."
    
    cat > "$outfile" << EOF
# ShadowOS Operation Summary
Generated: $(date)

## System Status

- **Boot Mode**: $(if [[ -e /dev/mapper/shadow_root ]]; then echo "Hidden Volume"; else echo "Normal"; fi)
- **RAM Workspace**: $(df -h /shadow 2>/dev/null | tail -1 | awk '{print $3 " / " $2}' || echo "N/A")
- **Uptime**: $(uptime -p)

## Network Status

- **Interface**: $(ip route get 1.1.1.1 2>/dev/null | grep -oP 'dev \K\S+' || echo "N/A")
- **Local IP**: $(hostname -I | awk '{print $1}')
- **External IP**: $(curl -s --max-time 3 ifconfig.me || echo "Unknown")
- **TOR**: $(pgrep tor &>/dev/null && echo "Active" || echo "Inactive")

## Stealth Status

$(shadow-stealth status 2>/dev/null | grep -E "Profile|MAC|Hostname" || echo "Not configured")

## Captured Data

### Credentials
$(wc -l /shadow/creds/credentials.db 2>/dev/null | awk '{print $1 " entries"}' || echo "0 entries")

### Network Captures
$(ls -1 /shadow/captures/*.pcap 2>/dev/null | wc -l || echo "0") files

### Scans
$(ls -1 /shadow/scans/ 2>/dev/null | wc -l || echo "0") results

### Recon
$(ls -1 /shadow/recon/ 2>/dev/null | wc -l || echo "0") targets

## WiFi Networks

### Saved Credentials
$(cat /var/lib/shadowos/wifi-credentials.db 2>/dev/null | wc -l || echo "0") networks

## Disk Usage

\`\`\`
$(df -h /shadow 2>/dev/null || echo "Workspace not mounted")
\`\`\`

---
*Report generated by ShadowOS*
EOF

    log "Report saved: $outfile"
    echo ""
    cat "$outfile"
}

# Generate credentials report
cmd_creds() {
    local outfile="${1:-$REPORT_DIR/credentials_$(date +%Y%m%d_%H%M%S).md}"
    
    mkdir -p "$REPORT_DIR"
    
    log "Generating credentials report..."
    
    cat > "$outfile" << 'HEADER'
# Captured Credentials Report

HEADER

    echo "Generated: $(date)" >> "$outfile"
    echo "" >> "$outfile"
    
    # WiFi credentials
    echo "## WiFi Networks" >> "$outfile"
    echo "" >> "$outfile"
    echo "| SSID | Password | Captured |" >> "$outfile"
    echo "|------|----------|----------|" >> "$outfile"
    
    if [[ -f /var/lib/shadowos/wifi-credentials.db ]]; then
        while IFS='|' read -r ssid pass ts; do
            echo "| $ssid | \`$pass\` | $ts |" >> "$outfile"
        done < /var/lib/shadowos/wifi-credentials.db
    else
        echo "| (none) | | |" >> "$outfile"
    fi
    
    echo "" >> "$outfile"
    
    # Other credentials
    echo "## Other Credentials" >> "$outfile"
    echo "" >> "$outfile"
    echo "| Type | Target | Username | Password |" >> "$outfile"
    echo "|------|--------|----------|----------|" >> "$outfile"
    
    if [[ -f /shadow/creds/credentials.db ]]; then
        while IFS='|' read -r ts type target user pass notes; do
            echo "| $type | $target | $user | \`$pass\` |" >> "$outfile"
        done < /shadow/creds/credentials.db
    else
        echo "| (none) | | | |" >> "$outfile"
    fi
    
    log "Report saved: $outfile"
}

# Export all data
cmd_export() {
    local outdir="${1:-$REPORT_DIR/export_$(date +%Y%m%d_%H%M%S)}"
    
    mkdir -p "$outdir"
    
    log "Exporting all data to: $outdir"
    
    # Copy all captured data
    cp -r /shadow/captures "$outdir/" 2>/dev/null || true
    cp -r /shadow/scans "$outdir/" 2>/dev/null || true
    cp -r /shadow/recon "$outdir/" 2>/dev/null || true
    cp -r /shadow/creds "$outdir/" 2>/dev/null || true
    
    # Generate summary
    cmd_summary "$outdir/summary.md"
    cmd_creds "$outdir/credentials.md"
    
    # Create archive
    local archive="$REPORT_DIR/shadowos_export_$(date +%Y%m%d_%H%M%S).tar.gz"
    tar -czf "$archive" -C "$(dirname "$outdir")" "$(basename "$outdir")"
    
    log "Archive created: $archive"
    log "Size: $(du -h "$archive" | cut -f1)"
}

show_help() {
    cat << 'EOF'
shadow-report - Generate Operation Reports

Create formatted reports from captured data.

Usage: shadow-report <command> [args]

Commands:
  summary [file]    Generate summary report
  creds [file]      Generate credentials report
  export [dir]      Export all data with reports

Examples:
  shadow-report summary
  shadow-report creds
  shadow-report export /usb/backup

Reports saved to /shadow/reports
EOF
}

case "${1:-summary}" in
    summary)  cmd_summary "${2:-}" ;;
    creds)    cmd_creds "${2:-}" ;;
    export)   cmd_export "${2:-}" ;;
    help|-h)  show_help ;;
    *)        error "Unknown: $1" ;;
esac
