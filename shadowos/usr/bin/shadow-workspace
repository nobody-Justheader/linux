#!/bin/bash
#
# shadow-workspace - ShadowOS RAM Workspace Manager
# /usr/bin/shadow-workspace
#
# Creates and manages RAM-only workspace at /shadow
# Everything stored here is volatile and never touches disk
#

set -euo pipefail

VERSION="1.0.0"
WORKSPACE="/shadow"
DEFAULT_SIZE="50%"  # 50% of RAM

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

log() {
    echo "[shadow-workspace] $*"
}

error() {
    echo "[shadow-workspace] ERROR: $*" >&2
    exit 1
}

get_ram_info() {
    local total_kb
    total_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
    local total_gb
    total_gb=$(echo "scale=1; $total_kb / 1024 / 1024" | bc)
    echo "$total_gb"
}

is_mounted() {
    mount | grep -q "on $WORKSPACE type tmpfs"
}

get_usage() {
    df -h "$WORKSPACE" 2>/dev/null | tail -1 | awk '{print $3 "/" $2 " (" $5 " used)"}'
}

# =============================================================================
# WORKSPACE MANAGEMENT
# =============================================================================

cmd_create() {
    local size="${1:-$DEFAULT_SIZE}"
    
    if is_mounted; then
        log "Workspace already exists at $WORKSPACE"
        cmd_status
        return 0
    fi
    
    log "Creating RAM workspace..."
    
    # Create mount point
    mkdir -p "$WORKSPACE"
    
    # Mount tmpfs with secure options
    mount -t tmpfs \
        -o "size=$size,mode=0700,noatime,nodev,nosuid,noexec,uid=$(id -u),gid=$(id -g)" \
        tmpfs "$WORKSPACE"
    
    # Create standard subdirectories
    mkdir -p "$WORKSPACE"/{downloads,documents,temp,captures,tools}
    
    log "✓ RAM workspace created at $WORKSPACE"
    log "  Size: $size of RAM"
    log "  Contents: NEVER written to disk"
    
    cmd_status
}

cmd_destroy() {
    if ! is_mounted; then
        log "No workspace mounted at $WORKSPACE"
        return 0
    fi
    
    log "⚠️  Destroying RAM workspace (all data will be lost)..."
    
    # Check for files
    local file_count
    file_count=$(find "$WORKSPACE" -type f 2>/dev/null | wc -l)
    
    if [[ $file_count -gt 0 ]]; then
        read -p "Workspace contains $file_count files. Destroy anyway? [y/N] " answer
        if [[ "$answer" != "y" && "$answer" != "Y" ]]; then
            log "Cancelled"
            return 1
        fi
    fi
    
    # Unmount
    umount -l "$WORKSPACE" 2>/dev/null || umount -f "$WORKSPACE"
    
    log "✓ RAM workspace destroyed"
}

cmd_status() {
    echo ""
    echo "╔═══════════════════════════════════════════════════════════════╗"
    echo "║                ShadowOS RAM Workspace Status                  ║"
    echo "╠═══════════════════════════════════════════════════════════════╣"
    
    if is_mounted; then
        printf "║  Status:      %-49s ║\n" "✓ ACTIVE"
        printf "║  Location:    %-49s ║\n" "$WORKSPACE"
        printf "║  Usage:       %-49s ║\n" "$(get_usage)"
        printf "║  Storage:     %-49s ║\n" "RAM only (never on disk)"
        
        echo "╠═══════════════════════════════════════════════════════════════╣"
        
        # Count files
        local file_count
        file_count=$(find "$WORKSPACE" -type f 2>/dev/null | wc -l)
        printf "║  Files:       %-49s ║\n" "$file_count"
        
        # Show subdirectories
        echo "╠═══════════════════════════════════════════════════════════════╣"
        echo "║  Directories:                                                 ║"
        for dir in "$WORKSPACE"/*/; do
            [[ -d "$dir" ]] || continue
            local name
            name=$(basename "$dir")
            local count
            count=$(find "$dir" -type f 2>/dev/null | wc -l)
            printf "║    %-20s (%d files)%*s║\n" "$name" "$count" $((30 - ${#count})) ""
        done
        
    else
        printf "║  Status:      %-49s ║\n" "✗ NOT ACTIVE"
        printf "║  %-61s ║\n" "Run 'shadow-workspace create' to start"
    fi
    
    echo "╚═══════════════════════════════════════════════════════════════╝"
    echo ""
}

cmd_wipe() {
    if ! is_mounted; then
        error "No workspace mounted at $WORKSPACE"
    fi
    
    log "Wiping all workspace contents..."
    
    # Secure delete all files
    find "$WORKSPACE" -type f -exec shred -fzun 3 {} \; 2>/dev/null || \
    find "$WORKSPACE" -type f -delete
    
    # Remove all directories (keeping top-level structure)
    find "$WORKSPACE" -mindepth 2 -type d -delete 2>/dev/null || true
    
    log "✓ Workspace wiped"
}

cmd_resize() {
    local new_size="${1:-}"
    
    if [[ -z "$new_size" ]]; then
        error "Usage: shadow-workspace resize <size>"
    fi
    
    if ! is_mounted; then
        error "No workspace mounted. Create one first."
    fi
    
    log "Resizing workspace to $new_size..."
    
    mount -o remount,size="$new_size" "$WORKSPACE"
    
    log "✓ Workspace resized to $new_size"
    cmd_status
}

show_help() {
    cat << 'EOF'
shadow-workspace - ShadowOS RAM Workspace Manager

Manage a volatile RAM-only workspace. Everything stored in /shadow
exists only in RAM and is never written to any disk.

Usage: shadow-workspace <command> [args]

Commands:
  create [size]     Create RAM workspace (default: 50% of RAM)
  destroy           Destroy workspace (all data lost)
  status            Show workspace status
  wipe              Securely wipe all contents
  resize <size>     Resize workspace (e.g., 2G, 75%)

Size formats:
  50%    - Percentage of total RAM
  2G     - Fixed size in gigabytes
  1024M  - Fixed size in megabytes

Directories created:
  /shadow/downloads    - Downloaded files
  /shadow/documents    - Working documents
  /shadow/temp         - Temporary files
  /shadow/captures     - Network captures
  /shadow/tools        - Portable tools

Security:
  • Data stored ONLY in RAM
  • Never written to swap (if noswap kernel param used)
  • Automatically destroyed on shutdown/reboot
  • noexec prevents accidental execution

EOF
}

# =============================================================================
# MAIN
# =============================================================================

# Check root for mounting
if [[ $EUID -ne 0 ]] && [[ "${1:-}" != "status" ]] && [[ "${1:-}" != "help" ]]; then
    echo "[!] Workspace management requires root privileges"
    echo "    Run with: sudo shadow-workspace $*"
    exit 1
fi

case "${1:-status}" in
    create|init|start)
        cmd_create "${2:-}"
        ;;
    destroy|delete|stop)
        cmd_destroy
        ;;
    status|info)
        cmd_status
        ;;
    wipe|clear|clean)
        cmd_wipe
        ;;
    resize)
        cmd_resize "${2:-}"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        error "Unknown command: $1"
        ;;
esac
