#!/bin/bash
#
# shadow-kali - Kali Repository Manager
# /usr/bin/shadow-kali
#
# Add Kali Linux repositories for security tools
#

set -euo pipefail

VERSION="1.0.0"
KALI_REPO="deb http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware"
KALI_KEY_URL="https://archive.kali.org/archive-key.asc"
KALI_KEY_FILE="/etc/apt/trusted.gpg.d/kali-archive-keyring.gpg"
SOURCES_FILE="/etc/apt/sources.list.d/kali.list"

log() { echo "[kali] $*"; }
error() { echo "[kali] ERROR: $*" >&2; exit 1; }

# Check if running Debian-based
is_debian() {
    [[ -f /etc/debian_version ]] || [[ -f /etc/apt/sources.list ]]
}

# Add Kali repository
cmd_add() {
    log "Adding Kali Linux repository..."
    
    if ! is_debian; then
        error "This system is not Debian-based. Kali repos require apt."
    fi
    
    # Import GPG key
    log "Importing Kali GPG key..."
    curl -fsSL "$KALI_KEY_URL" | gpg --dearmor -o "$KALI_KEY_FILE"
    
    # Add repository
    log "Adding repository..."
    echo "$KALI_REPO" > "$SOURCES_FILE"
    
    # Set lower priority (don't replace system packages)
    cat > /etc/apt/preferences.d/kali.pref << 'EOF'
Package: *
Pin: release o=Kali
Pin-Priority: 50

Package: aircrack-ng nmap metasploit-framework hashcat john hydra sqlmap nikto wifite
Pin: release o=Kali
Pin-Priority: 500
EOF
    
    # Update package list
    log "Updating package lists..."
    apt-get update
    
    log "✓ Kali repository added!"
    log ""
    log "Install security tools:"
    log "  apt install kali-tools-top10"
    log "  apt install kali-tools-wireless"
    log "  apt install kali-tools-web"
}

# Remove Kali repository
cmd_remove() {
    log "Removing Kali repository..."
    
    rm -f "$SOURCES_FILE"
    rm -f "$KALI_KEY_FILE"
    rm -f /etc/apt/preferences.d/kali.pref
    
    apt-get update
    
    log "✓ Kali repository removed"
}

# Check status
cmd_status() {
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║               Kali Repository Status                       ║"
    echo "╠════════════════════════════════════════════════════════════╣"
    
    if [[ -f "$SOURCES_FILE" ]]; then
        printf "║  Status:   %-49s ║\n" "✓ ENABLED"
        printf "║  Source:   %-49s ║\n" "kali-rolling"
    else
        printf "║  Status:   %-49s ║\n" "Not configured"
    fi
    
    echo "╚════════════════════════════════════════════════════════════╝"
}

# Install tool categories
cmd_install() {
    local category="${1:-top10}"
    
    case "$category" in
        top10)
            log "Installing top 10 tools..."
            apt-get install -y kali-tools-top10
            ;;
        wireless|wifi)
            log "Installing wireless tools..."
            apt-get install -y kali-tools-wireless
            ;;
        web)
            log "Installing web tools..."
            apt-get install -y kali-tools-web
            ;;
        passwords|pw)
            log "Installing password tools..."
            apt-get install -y kali-tools-passwords
            ;;
        exploitation|exploit)
            log "Installing exploitation tools..."
            apt-get install -y kali-tools-exploitation
            ;;
        forensics)
            log "Installing forensics tools..."
            apt-get install -y kali-tools-forensics
            ;;
        sniffing|sniffer)
            log "Installing sniffing tools..."
            apt-get install -y kali-tools-sniffing-spoofing
            ;;
        reversing|reverse)
            log "Installing reverse engineering tools..."
            apt-get install -y kali-tools-reverse-engineering
            ;;
        all)
            log "Installing all Kali tools (this will take a while)..."
            apt-get install -y kali-linux-large
            ;;
        *)
            log "Available categories:"
            echo "  top10, wireless, web, passwords, exploitation"
            echo "  forensics, sniffing, reversing, all"
            ;;
    esac
}

# List available metapackages
cmd_list() {
    echo ""
    echo "╔═══════════════════════════════════════════════════════════════════════╗"
    echo "║                    Kali Tool Categories                               ║"
    echo "╠═══════════════════════════════════════════════════════════════════════╣"
    echo "║  Category          Package                    Description             ║"
    echo "╠═══════════════════════════════════════════════════════════════════════╣"
    echo "║  top10             kali-tools-top10           Most popular tools      ║"
    echo "║  wireless          kali-tools-wireless        WiFi hacking            ║"
    echo "║  web               kali-tools-web             Web app testing         ║"
    echo "║  passwords         kali-tools-passwords       Password cracking       ║"
    echo "║  exploitation      kali-tools-exploitation    Exploit frameworks      ║"
    echo "║  forensics         kali-tools-forensics       Digital forensics       ║"
    echo "║  sniffing          kali-tools-sniffing        Traffic analysis        ║"
    echo "║  reversing         kali-tools-reverse         Binary analysis         ║"
    echo "║  all               kali-linux-large           Everything (~15GB)      ║"
    echo "╚═══════════════════════════════════════════════════════════════════════╝"
}

show_help() {
    cat << 'EOF'
shadow-kali - Kali Repository Manager

Add Kali Linux repositories for security tools on Debian/Ubuntu.

Usage: shadow-kali <command> [args]

Commands:
  add              Add Kali repository
  remove           Remove Kali repository
  status           Check repository status
  install <cat>    Install tool category
  list             List available categories

Categories:
  top10, wireless, web, passwords, exploitation,
  forensics, sniffing, reversing, all

Examples:
  shadow-kali add
  shadow-kali install wireless
  shadow-kali install top10

Note: Kali packages are pinned at low priority to avoid
replacing system packages. Only security tools are prioritized.
EOF
}

[[ $EUID -ne 0 ]] && error "Must run as root"

case "${1:-help}" in
    add)      cmd_add ;;
    remove)   cmd_remove ;;
    status)   cmd_status ;;
    install)  cmd_install "${2:-}" ;;
    list|ls)  cmd_list ;;
    help|-h)  show_help ;;
    *)        error "Unknown: $1" ;;
esac
