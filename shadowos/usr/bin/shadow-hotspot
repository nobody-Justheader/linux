#!/bin/bash
#
# shadow-hotspot - ShadowOS Secure WiFi Hotspot
# /usr/bin/shadow-hotspot
#
# Creates a secure WPA3/WPA2 access point with DHCP/DNS
#

set -euo pipefail

VERSION="1.0.0"
CONF_DIR="/tmp/shadowos-hotspot"
DEFAULT_INTERFACE="wlan0"
DEFAULT_SSID="ShadowAP"
DEFAULT_CHANNEL=6
GATEWAY="10.13.37.1"
DHCP_RANGE="10.13.37.10,10.13.37.250"

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

log() {
    echo "[shadow-hotspot] $*"
}

generate_password() {
    # Generate strong random password
    openssl rand -base64 16 | tr -d '/+=' | head -c 16
}

check_interface() {
    local iface="$1"
    [[ -d "/sys/class/net/$iface" ]] || {
        log "Interface $iface not found"
        return 1
    }
}

get_internet_interface() {
    # Find interface with default route (internet)
    ip route | grep default | awk '{print $5}' | head -1
}

# =============================================================================
# HOTSPOT MANAGEMENT
# =============================================================================

cmd_start() {
    local interface="${1:-$DEFAULT_INTERFACE}"
    local ssid="${2:-$DEFAULT_SSID}"
    local password="${3:-$(generate_password)}"
    local channel="${4:-$DEFAULT_CHANNEL}"
    
    log "Starting secure hotspot..."
    
    # Check interface
    check_interface "$interface" || exit 1
    
    # Stop any existing hotspot
    cmd_stop &>/dev/null || true
    
    # Create config directory
    mkdir -p "$CONF_DIR"
    
    # Determine internet interface for NAT
    local internet_if
    internet_if=$(get_internet_interface)
    
    # Configure interface
    log "Configuring $interface..."
    ip link set "$interface" down 2>/dev/null || true
    ip addr flush dev "$interface" 2>/dev/null || true
    ip addr add "$GATEWAY/24" dev "$interface"
    ip link set "$interface" up
    
    # Create hostapd config (WPA3 + WPA2 fallback)
    log "Creating hostapd configuration..."
    cat > "$CONF_DIR/hostapd.conf" << EOF
# ShadowOS Secure Hotspot Configuration
interface=$interface
driver=nl80211
ssid=$ssid
hw_mode=g
channel=$channel
wmm_enabled=1
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0

# WPA2/WPA3 Security
wpa=2
wpa_passphrase=$password
wpa_key_mgmt=SAE WPA-PSK
wpa_pairwise=CCMP
rsn_pairwise=CCMP

# WPA3 settings
ieee80211w=1
sae_require_mfp=1

# Country code (adjust as needed)
country_code=US

# Logging
logger_syslog=-1
logger_syslog_level=2
EOF

    # Create dnsmasq config (DHCP + DNS)
    log "Creating DHCP/DNS configuration..."
    cat > "$CONF_DIR/dnsmasq.conf" << EOF
# ShadowOS Hotspot DHCP/DNS
interface=$interface
bind-interfaces
dhcp-range=$DHCP_RANGE,255.255.255.0,12h
dhcp-option=3,$GATEWAY
dhcp-option=6,$GATEWAY

# DNS servers (Cloudflare + Google as fallback)
server=1.1.1.1
server=8.8.8.8

# Logging
log-queries
log-dhcp

# Lease file
dhcp-leasefile=$CONF_DIR/dnsmasq.leases
EOF

    # Enable IP forwarding
    log "Enabling IP forwarding..."
    echo 1 > /proc/sys/net/ipv4/ip_forward
    
    # Setup NAT if we have internet
    if [[ -n "$internet_if" ]]; then
        log "Setting up NAT ($interface -> $internet_if)..."
        
        # Clear existing rules for our interface
        iptables -t nat -D POSTROUTING -o "$internet_if" -j MASQUERADE 2>/dev/null || true
        iptables -D FORWARD -i "$interface" -o "$internet_if" -j ACCEPT 2>/dev/null || true
        iptables -D FORWARD -i "$internet_if" -o "$interface" -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || true
        
        # Add NAT rules
        iptables -t nat -A POSTROUTING -o "$internet_if" -j MASQUERADE
        iptables -A FORWARD -i "$interface" -o "$internet_if" -j ACCEPT
        iptables -A FORWARD -i "$internet_if" -o "$interface" -m state --state RELATED,ESTABLISHED -j ACCEPT
    fi
    
    # Start dnsmasq
    log "Starting DHCP/DNS server..."
    dnsmasq -C "$CONF_DIR/dnsmasq.conf" --pid-file="$CONF_DIR/dnsmasq.pid" &
    
    sleep 1
    
    # Start hostapd
    log "Starting access point..."
    hostapd "$CONF_DIR/hostapd.conf" -B -P "$CONF_DIR/hostapd.pid" 2>&1 | grep -v "^$" &
    
    sleep 3
    
    # Check if running
    if pgrep -x hostapd &>/dev/null; then
        echo ""
        echo "╔═══════════════════════════════════════════════════════════════╗"
        echo "║              ShadowOS Secure Hotspot Active                   ║"
        echo "╠═══════════════════════════════════════════════════════════════╣"
        printf "║  SSID:        %-49s ║\n" "$ssid"
        printf "║  Password:    %-49s ║\n" "$password"
        printf "║  Gateway:     %-49s ║\n" "$GATEWAY"
        printf "║  Security:    %-49s ║\n" "WPA3-SAE / WPA2"
        printf "║  Interface:   %-49s ║\n" "$interface"
        if [[ -n "$internet_if" ]]; then
            printf "║  Internet:    %-49s ║\n" "Shared via $internet_if"
        else
            printf "║  Internet:    %-49s ║\n" "Not available"
        fi
        echo "╚═══════════════════════════════════════════════════════════════╝"
        echo ""
        
        # Save info for status command
        cat > "$CONF_DIR/info" << EOF
SSID=$ssid
PASSWORD=$password
INTERFACE=$interface
GATEWAY=$GATEWAY
INTERNET_IF=$internet_if
STARTED=$(date +%s)
EOF
        
        log "Hotspot started successfully!"
    else
        log "Failed to start hostapd. Check logs."
        cmd_stop
        exit 1
    fi
}

cmd_stop() {
    log "Stopping hotspot..."
    
    # Kill services
    [[ -f "$CONF_DIR/hostapd.pid" ]] && kill $(cat "$CONF_DIR/hostapd.pid") 2>/dev/null || true
    [[ -f "$CONF_DIR/dnsmasq.pid" ]] && kill $(cat "$CONF_DIR/dnsmasq.pid") 2>/dev/null || true
    
    killall hostapd 2>/dev/null || true
    pkill -f "dnsmasq.*shadowos-hotspot" 2>/dev/null || true
    
    # Clean up iptables (best effort)
    local internet_if
    internet_if=$(get_internet_interface)
    if [[ -n "$internet_if" ]]; then
        iptables -t nat -D POSTROUTING -o "$internet_if" -j MASQUERADE 2>/dev/null || true
    fi
    
    # Clean up config
    rm -rf "$CONF_DIR"
    
    log "Hotspot stopped"
}

cmd_status() {
    echo ""
    echo "╔═══════════════════════════════════════════════════════════════╗"
    echo "║                  ShadowOS Hotspot Status                      ║"
    echo "╠═══════════════════════════════════════════════════════════════╣"
    
    if pgrep -x hostapd &>/dev/null && [[ -f "$CONF_DIR/info" ]]; then
        source "$CONF_DIR/info"
        
        printf "║  Status:      %-49s ║\n" "✓ ACTIVE"
        printf "║  SSID:        %-49s ║\n" "$SSID"
        printf "║  Password:    %-49s ║\n" "$PASSWORD"
        printf "║  Gateway:     %-49s ║\n" "$GATEWAY"
        
        # Count clients
        local clients=0
        if [[ -f "$CONF_DIR/dnsmasq.leases" ]]; then
            clients=$(wc -l < "$CONF_DIR/dnsmasq.leases")
        fi
        printf "║  Clients:     %-49s ║\n" "$clients connected"
        
    else
        printf "║  Status:      %-49s ║\n" "✗ NOT RUNNING"
    fi
    
    echo "╚═══════════════════════════════════════════════════════════════╝"
    echo ""
}

cmd_clients() {
    echo ""
    echo "=== Connected Clients ==="
    echo ""
    
    if [[ -f "$CONF_DIR/dnsmasq.leases" ]] && [[ -s "$CONF_DIR/dnsmasq.leases" ]]; then
        printf "%-18s %-16s %s\n" "MAC Address" "IP Address" "Hostname"
        printf "%s\n" "───────────────────────────────────────────────────"
        
        while read -r timestamp mac ip hostname _; do
            printf "%-18s %-16s %s\n" "$mac" "$ip" "${hostname:-unknown}"
        done < "$CONF_DIR/dnsmasq.leases"
    else
        echo "  (no clients connected)"
    fi
    echo ""
}

show_help() {
    cat << 'EOF'
shadow-hotspot - ShadowOS Secure WiFi Hotspot

Create a secure WPA3/WPA2 access point with internet sharing.

Usage: shadow-hotspot <command> [args]

Commands:
  start [if] [ssid] [pass] [ch]   Start secure hotspot
  stop                             Stop hotspot
  status                           Show hotspot status
  clients                          List connected clients

Arguments:
  if     - WiFi interface (default: wlan0)
  ssid   - Network name (default: ShadowAP)
  pass   - Password (default: random 16 char)
  ch     - Channel 1-11 (default: 6)

Examples:
  shadow-hotspot start                              # Quick start
  shadow-hotspot start wlan0 MyNetwork MyPass 11   # Custom config
  shadow-hotspot clients                            # List clients
  shadow-hotspot stop                               # Stop hotspot

Security: WPA3-SAE with WPA2 fallback for compatibility.
Internet is automatically shared if available.

EOF
}

# =============================================================================
# MAIN
# =============================================================================

# Check for root
if [[ $EUID -ne 0 ]] && [[ "${1:-}" != "help" ]]; then
    echo "[!] Hotspot requires root privileges"
    echo "    Run with: sudo shadow-hotspot $*"
    exit 1
fi

case "${1:-status}" in
    start)
        cmd_start "${2:-}" "${3:-}" "${4:-}" "${5:-}"
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    clients|list)
        cmd_clients
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "[!] Unknown command: $1"
        show_help
        exit 1
        ;;
esac
