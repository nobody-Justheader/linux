#!/bin/bash
#
# mkinitcpio hook for ShadowOS hidden boot (Arch Linux)
# /etc/initcpio/hooks/shadow
#

run_hook() {
    local shadow_boot=0
    
    # Check kernel cmdline for shadow boot
    for param in $(cat /proc/cmdline); do
        case "$param" in
            shadowboot|shadow.boot|hidden)
                shadow_boot=1
                ;;
        esac
    done
    
    [ $shadow_boot -eq 0 ] && return 0
    
    msg "ShadowOS: Initiating hidden boot..."
    
    # Load crypto modules
    modprobe -q dm_crypt
    modprobe -q xts
    modprobe -q aes_generic
    
    # Find encrypted partition
    local crypt_dev=""
    for dev in /dev/sd?3 /dev/sd?2 /dev/nvme?n1p3; do
        [ -b "$dev" ] || continue
        if cryptsetup isLuks "$dev" 2>/dev/null; then
            crypt_dev="$dev"
            break
        fi
    done
    
    [ -z "$crypt_dev" ] && { err "No encrypted partition"; return 1; }
    
    # Find header
    local header=""
    modprobe -q vfat
    for dev in /dev/sd?1 /dev/sd?2; do
        [ -b "$dev" ] || continue
        mkdir -p /tmp/hdr
        if mount -t vfat -o ro "$dev" /tmp/hdr 2>/dev/null; then
            if [ -f /tmp/hdr/.shadow/header.bin ]; then
                header="/tmp/hdr/.shadow/header.bin"
                break
            fi
            umount /tmp/hdr
        fi
    done
    
    # Prompt and decrypt
    echo ""
    echo "╔═══════════════════════════════════════════════════════════╗"
    echo "║                    ShadowOS Boot                          ║"
    echo "╚═══════════════════════════════════════════════════════════╝"
    echo ""
    
    local tries=3
    while [ $tries -gt 0 ]; do
        echo -n "Password: "
        read -s pass
        echo ""
        
        local opts=""
        [ -n "$header" ] && opts="--header $header"
        
        if echo "$pass" | cryptsetup open $opts "$crypt_dev" shadow_root 2>/dev/null; then
            msg "ShadowOS: Decrypted"
            [ -n "$header" ] && umount /tmp/hdr 2>/dev/null
            return 0
        fi
        
        tries=$((tries - 1))
        [ $tries -gt 0 ] && echo "[!] Invalid. $tries left."
    done
    
    err "Decryption failed"
    return 1
}

run_cleanuphook() {
    # Cleanup after boot
    rm -f /tmp/shadow_header.bin 2>/dev/null
}
