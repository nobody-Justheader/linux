#!/bin/sh
# Minimal ShadowOS Init - Debug version

# Mount essential filesystems first
/bin/busybox mkdir -p /proc /sys /dev /mnt /tmp
/bin/busybox mount -t proc proc /proc
/bin/busybox mount -t sysfs sysfs /sys
/bin/busybox mount -t devtmpfs devtmpfs /dev 2>/dev/null || /bin/busybox mount -t tmpfs tmpfs /dev

# Create essential device nodes
/bin/busybox mknod -m 666 /dev/null c 1 3 2>/dev/null
/bin/busybox mknod -m 666 /dev/zero c 1 5 2>/dev/null
/bin/busybox mknod -m 600 /dev/console c 5 1 2>/dev/null
/bin/busybox mknod -m 666 /dev/tty c 5 0 2>/dev/null

echo "=== ShadowOS Init ==="
echo "Kernel: $(/bin/busybox uname -r)"
echo "Cmdline: $(/bin/busybox cat /proc/cmdline)"

# Load essential modules
echo "Loading modules..."
for mod in loop squashfs overlay isofs sr_mod cdrom sd_mod usb_storage ahci ata_piix virtio_blk virtio_pci; do
    /bin/busybox modprobe $mod 2>/dev/null && echo "  Loaded: $mod"
done

# Trigger device discovery
if [ -x /bin/busybox ]; then
    echo /bin/busybox > /proc/sys/kernel/hotplug 2>/dev/null
    /bin/busybox mdev -s 2>/dev/null
fi

# Wait a moment for devices
sleep 2

echo ""
echo "Searching for boot media..."
echo "Block devices:"
/bin/busybox blkid 2>/dev/null || echo "(none found)"

# Try to find and mount the boot device
BOOT_DEV=""
for dev in /dev/sr0 /dev/sr1 /dev/sda /dev/sda1 /dev/vda /dev/vda1; do
    if [ -b "$dev" ]; then
        echo "Trying $dev..."
        /bin/busybox mkdir -p /mnt/cdrom
        if /bin/busybox mount -o ro "$dev" /mnt/cdrom 2>/dev/null; then
            if [ -f /mnt/cdrom/live/filesystem.squashfs ]; then
                BOOT_DEV="$dev"
                echo "Found boot media: $dev"
                break
            fi
            /bin/busybox umount /mnt/cdrom 2>/dev/null
        fi
    fi
done

if [ -z "$BOOT_DEV" ]; then
    echo "ERROR: Could not find boot media!"
    echo "Dropping to rescue shell..."
    exec /bin/busybox sh
fi

# Mount SquashFS
echo "Mounting SquashFS..."
/bin/busybox mkdir -p /mnt/lower /mnt/upper /mnt/work /mnt/root

if ! /bin/busybox mount -t squashfs -o ro,loop /mnt/cdrom/live/filesystem.squashfs /mnt/lower; then
    echo "ERROR: Failed to mount SquashFS"
    exec /bin/busybox sh
fi
echo "SquashFS mounted"

# Create overlay
echo "Creating overlay..."
/bin/busybox mount -t tmpfs tmpfs /mnt/upper
/bin/busybox mkdir -p /mnt/upper/upper /mnt/upper/work

if ! /bin/busybox mount -t overlay overlay -o lowerdir=/mnt/lower,upperdir=/mnt/upper/upper,workdir=/mnt/upper/work /mnt/root; then
    echo "ERROR: Failed to create overlay"
    echo "Trying bind mount instead..."
    /bin/busybox mount --bind /mnt/lower /mnt/root
fi
echo "Root ready"

# Prepare for switch
/bin/busybox mkdir -p /mnt/root/proc /mnt/root/sys /mnt/root/dev /mnt/root/run
/bin/busybox mount --move /proc /mnt/root/proc
/bin/busybox mount --move /sys /mnt/root/sys
/bin/busybox mount --move /dev /mnt/root/dev
/bin/busybox mount -t tmpfs tmpfs /mnt/root/run

# Keep boot media accessible
/bin/busybox mkdir -p /mnt/root/media/cdrom
/bin/busybox mount --move /mnt/cdrom /mnt/root/media/cdrom 2>/dev/null

echo "Switching to root..."
cd /mnt/root
exec /bin/busybox switch_root /mnt/root /sbin/init

# If we get here, switch_root failed
echo "switch_root failed!"
exec /bin/busybox sh
