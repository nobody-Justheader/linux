# ShadowOS GRUB Configuration
# Template for USB/Manual installations
# NOTE: This file is overridden by build-iso.sh during ISO creation
#
# USB Drive → Hidden encrypted boot (shadowboot kernel param)
# ISO/DVD   → Standard live boot

# Serial console for debugging - initialize FIRST
insmod serial
serial --speed=115200 --unit=0 --word=8 --parity=no --stop=1

# Start with console terminal (guaranteed to work)
terminal_input console serial
terminal_output console serial

set timeout=5
set default=0

# Try to upgrade to graphics mode (optional, non-fatal if fails)
insmod all_video
insmod gfxterm
insmod png

if [ "$grub_platform" = "efi" ]; then
    # EFI usually has better graphics support
    set gfxmode=auto
    set gfxpayload=keep
    terminal_output gfxterm
elif [ -n "$have_video" ]; then
    # BIOS with video - try gfxterm but keep console as backup
    set gfxmode=800x600,auto
    set gfxpayload=text
fi

# Detect boot media type
if [ -f /.shadow/header.bin ] || [ -f ($root)/.shadow/header.bin ]; then
    # USB with hidden partition detected - encrypted boot
    set shadowos_mode="encrypted"
else
    # Live media - standard live mode
    set shadowos_mode="live"
fi

# Main boot entry
menuentry "ShadowOS Live" {
    if [ "$shadowos_mode" = "encrypted" ]; then
        # Hidden encrypted boot
        linux /boot/vmlinuz shadowboot quiet splash loglevel=0 noswap console=tty0 console=ttyS0,115200n8
        initrd /boot/initrd.img
    else
        # Live mode
        linux /boot/vmlinuz boot=live components live-media=/dev/sr0 quiet splash console=tty0 console=ttyS0,115200n8
        initrd /boot/initrd.img
    fi
}

menuentry "ShadowOS Live (Safe Graphics - nomodeset)" {
    if [ "$shadowos_mode" = "encrypted" ]; then
        linux /boot/vmlinuz shadowboot nomodeset quiet splash noswap console=tty0 console=ttyS0,115200n8
        initrd /boot/initrd.img
    else
        linux /boot/vmlinuz boot=live components live-media=/dev/sr0 nomodeset quiet splash console=tty0 console=ttyS0,115200n8
        initrd /boot/initrd.img
    fi
}

menuentry "ShadowOS (Debug)" {
    if [ "$shadowos_mode" = "encrypted" ]; then
        linux /boot/vmlinuz shadowboot debug noswap console=tty0 console=ttyS0,115200n8
        initrd /boot/initrd.img
    else
        linux /boot/vmlinuz boot=live components live-media=/dev/sr0 debug console=tty0 console=ttyS0,115200n8
        initrd /boot/initrd.img
    fi
}
